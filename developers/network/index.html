<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://tronprotocol.github.io/documentation-en/developers/network/" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Network - Java Tron</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Network";
        var mkdocs_page_input_path = "developers/network.md";
        var mkdocs_page_url = "/documentation-en/developers/network/";
      </script>
    
    <script src="../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> Java Tron
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Getting Started</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../getting_started/getting_started_with_javatron/">Getting Started with Java-tron</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Using Java-tron</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../using_javatron/installing_javatron/">Deploying Java-tron</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../using_javatron/backup_restore/">Backup & Restore</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../litefullnode/">Lite Fullnode</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../using_javatron/private_network/">Private Network</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../architecture/event/">Event Plugin</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../architecture/database/">Database Configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../using_javatron/connecting_to_tron/">Network Configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../using_javatron/metrics/">Node Monitoring</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Tools</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../using_javatron/toolkit/">Database Partition</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">API</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/http/">HTTP API</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/rpc/">gRPC API</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Core Protocal</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../introduction/dpos/">DPoS</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../mechanism-algorithm/sr/">Super Representative</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../mechanism-algorithm/account/">Account Model</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../mechanism-algorithm/resource/">Resource Model</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../contracts/contract/">Smart Contract</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../mechanism-algorithm/dex/">Decentralized Exchange</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../mechanism-algorithm/multi-signatures/">Multi-Signature</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">For Java-tron Developers</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../java-tron/">Developer Guide</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../tips/">TIPs Workflow</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../issue-workflow/">Issue Workflow</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../governance/">Governance Workflow</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../run-in-idea/">Configure the IDE</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../demo/">Development Example</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Core Modules</a>
    <ul class="current">
                <li class="toctree-l2"><a class="reference internal" href="../code-structure/">Overview</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../chainbase/">Chainbase</a>
                </li>
                <li class="toctree-l2 current"><a class="reference internal current" href="./">Network</a>
    <ul class="current">
    <li class="toctree-l3"><a class="reference internal" href="#overview">Overview</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#blockchain-network">Blockchain Network</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#tron-network">TRON Network</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#node-discovery">Node Discovery</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#kademlia-algorithm">Kademlia Algorithm</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#kademlia-implementation-by-tron">Kademlia Implementation by TRON</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#node-connection">Node Connection</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#peer-node-management">Peer Node Management</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#establish-tcp-connection-with-peers">Establish TCP Connection with Peers</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#handshake">Handshake</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#channel-keep-alive">Channel Keep-Alive</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#block-synchronization">Block Synchronization</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#blockchain-summary-and-list-of-missing-blocks">Blockchain Summary and List of Missing Blocks</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#block-and-transaction-broadcast">Block and Transaction Broadcast</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#summary">Summary</a>
    </li>
    </ul>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">For DAPP developers</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../contracts/compiler/">Dapp Development Tool</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Wallet-cli</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../clients/wallet-cli/">What is Wallet-CLI</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../clients/wallet-cli-command/">Wallet Commands</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Releases</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../releases/upgrade-instruction/">Deployment Manual for the New Version</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../releases/">Integrity Check</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">History</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../releases/GreatVoyage-v460/">GreatVoyage-v4.6.0</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../releases/GreatVoyage-v452/">GreatVoyage-v4.5.2</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../releases/GreatVoyage-v451/">GreatVoyage-v4.5.1</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../releases/GreatVoyage-v446/">GreatVoyage-v4.4.6</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../releases/GreatVoyage-v445/">GreatVoyage-v4.4.5</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../releases/GreatVoyage-v444/">GreatVoyage-v4.4.4</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../releases/GreatVoyage-v442/">GreatVoyage-v4.4.2</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../releases/GreatVoyage-v440/">GreatVoyage-v4.4.0</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../releases/GreatVoyage-v430/">GreatVoyage-v4.3.0</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../releases/GreatVoyage-v4221/">GreatVoyage-v4.2.2.1</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../releases/GreatVoyage-v422/">GreatVoyage-v4.2.2</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../releases/GreatVoyage-v420/">GreatVoyage-v4.2.0</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../releases/GreatVoyage-v413/">GreatVoyage-v4.1.3</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../releases/GreatVoyage-v412/">GreatVoyage-v4.1.2</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../releases/GreatVoyage-v411/">GreatVoyage-v4.1.1</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../releases/GreatVoyage-v400/">GreatVoyage-v4.0.0</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../releases/Odyssey-v37/">Odyssey-v3.7</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../releases/Odyssey-v365/">Odyssey-v3.6.5</a>
                </li>
    </ul>
                  </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../glossary/">Glossary</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">Java Tron</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>For Java-tron Developers &raquo;</li>
          <li>Core Modules &raquo;</li><li>Network</li>
    <li class="wy-breadcrumbs-aside">
        <a href="https://github.com/tronprotocol/documentation-en/edit/master/docs/developers/network.md"
          class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>

          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="network">Network<a class="headerlink" href="#network" title="Permanent link">&para;</a></h1>
<h2 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">&para;</a></h2>
<p>P2P is a distributed network in which participants in the network share a part of the hardware resources they own, such as processing power, storage capacity, network connection capacity, printers, etc. These shared resources need to be provided services and content by the network, which can be accessed by other peers directly without going through an intermediate entity. Participants in this network are both providers and acquirers of service and content.</p>
<p>Different from the traditional Client/Server central server structure, the status of each node in the P2P network is equal. While serving as a client, each node can also serve as a server to provide services to other nodes, which greatly improves the utilization of resources.</p>
<h3 id="blockchain-network">Blockchain Network<a class="headerlink" href="#blockchain-network" title="Permanent link">&para;</a></h3>
<p>P2P is the network layer in the blockchain structure. The main purpose of the network layer is to realize information broadcast, verification and communication between nodes. The blockchain network is essentially a P2P network, and each node can both receive and generate information. Nodes keep communication by maintaining common blockchain data.</p>
<p>As the foundation of the blockchain, the P2P network brings the following advantages to the blockchain:</p>
<ul>
<li>Prevent single-point attack</li>
<li>High fault tolerance</li>
<li>Better compatibility and scalability</li>
</ul>
<h3 id="tron-network">TRON Network<a class="headerlink" href="#tron-network" title="Permanent link">&para;</a></h3>
<p>The architecture diagram of TRON is as follows:
<img alt="image" src="https://raw.githubusercontent.com/tronprotocol/documentation-en/master/images/network_architecture.png" /></p>
<p>As the most fundamental module of TRON, the P2P network directly determines the stability of the entire blockchain network. The network module can be divided into the following four parts according to the function:</p>
<ul>
<li><a href="#node-discovery">Node Discovery</a></li>
<li><a href="#node-connection">Node Connection</a></li>
<li><a href="#block-synchronization">Block Synchronization</a></li>
<li><a href="#block-and-transaction-broadcast">Block and Transaction Broadcast</a></li>
</ul>
<p>Below will separately introduce these four functional parts.</p>
<h2 id="node-discovery">Node Discovery<a class="headerlink" href="#node-discovery" title="Permanent link">&para;</a></h2>
<p>Node discovery is the first step for nodes to access the blockchain network. The blockchain network is a structured P2P network which organizes all nodes in an orderly manner, such as forming a ring network or a tree-like network. Structured networks are generally implemented based on the DHT (Distributed Hash Table) algorithm. Specific implementation algorithms include Chord, Pastry, CAN, Kademlia and so on. The TRON network uses the Kademlia algorithm.</p>
<h3 id="kademlia-algorithm">Kademlia Algorithm<a class="headerlink" href="#kademlia-algorithm" title="Permanent link">&para;</a></h3>
<p>Kademlia is an implementation of Distributed Hash Table (DHT), it is the core routing technology in the decentralized P2P network and can quickly find target nodes in the network without a central server.</p>
<p>For a detailed introduction to the algorithm, please refer to <a href="https://en.wikipedia.org/wiki/Kademlia">Kademlia</a>.</p>
<h3 id="kademlia-implementation-by-tron">Kademlia Implementation by TRON<a class="headerlink" href="#kademlia-implementation-by-tron" title="Permanent link">&para;</a></h3>
<p>The main points of the Kademlia algorithm implemented by TRON are as follows:</p>
<ul>
<li>Node ID: Randomly generated 512bit ID</li>
<li>Node Distance: The node distance is obtained through the XOR operation of two nodes' ID. The formula is: <code>Node distance = 256 - the number of leading 0s in the node ID XOR result</code>, if the calculation result is negative, the distance is equal to 0.</li>
<li>K-Bucket: The node routing table. According to the distance between the nodes, the remote nodes are divided into different buckets. The remote nodes with the same distance as the current node are recorded in the same bucket, and each bucket can accommodate up to 16 nodes. According to the calculation formula of node distance, it can be seen that the Kademlia algorithm implemented by TRON maintains a total of 256 buckets.</li>
</ul>
<p>The node discovery protocol of TRON includes the following four UDP messages:</p>
<ul>
<li><code>DISCOVER_PING</code> - used to detect if a node is online</li>
<li><code>DISCOVER_PONG</code> - used in response to <code>DISCOVER_PING</code> message</li>
<li><code>DISCOVER_FIND_NODE</code> - used to find other nodes closest to the target node</li>
<li><code>DISCOVER_NEIGHBORS</code> - used in response to <code>DISCOVER_FIND_NODE</code> message, will return one or more nodes, up to 16</li>
</ul>
<h4 id="initialize-k-buckets">Initialize K-Buckets<a class="headerlink" href="#initialize-k-buckets" title="Permanent link">&para;</a></h4>
<p>After the node is started, it will read the seed nodes configured in the node configuration file and the peer nodes recorded in the database, and then send <code>DISCOVER_PING</code> message to them respectively. If the reply message <code>DISCOVER_PONG</code> from a peer is received, and at the condition that the K bucket is not full, it will then write the peer node into the K bucket; But if the corresponding bucket has already been full (that is the bucket has reached 16 nodes), it will challenge to the earliest node in the bucket. If the challenge is successful, the old node will be deleted, and the new node will be added to the K bucket. That is the K bucket initialization process, then the node discovery process is performed.</p>
<p><img alt="image" src="https://raw.githubusercontent.com/tronprotocol/documentation-en/master/images/network_discoverinit.png" /></p>
<h4 id="send-discover_find_node-to-find-more-nodes">Send DISCOVER_FIND_NODE to Find More Nodes<a class="headerlink" href="#send-discover_find_node-to-find-more-nodes" title="Permanent link">&para;</a></h4>
<p>The node discovery service will start two scheduled tasks (<code>DiscoverTask</code> and <code>RefreshTask</code>) to periodically perform the node discovery process to update k buckets.</p>
<ul>
<li><code>DiscoverTask</code> is to discover more nodes that are closer to myself. It is executed every 30s. The execution flow is as follows:
    <img alt="image" src="https://raw.githubusercontent.com/tronprotocol/documentation-en/master/images/network_discovertask.png" /></li>
<li><code>RefreshTask</code> is to expand the local k-bucket by random node ID, that is, to find nodes that are closer to the random node ID. It is executed every 7.2s. The execution process is as follows:
    <img alt="image" src="https://raw.githubusercontent.com/tronprotocol/documentation-en/master/images/network_refreshtask.png" /></li>
</ul>
<p>The node discovery algorithm used in <code>DiscoverTask</code> and <code>RefreshTask</code> will be executed 8 rounds in one call, and each round sends <code>DISCOVER_FIND_NODE</code> message to the 3 nodes closest to the target node ID in the K bucket, and waits for a reply.</p>
<h4 id="receive-neighbors-messages-and-update-k-bucket">Receive Neighbors' Messages and Update K Bucket<a class="headerlink" href="#receive-neighbors-messages-and-update-k-bucket" title="Permanent link">&para;</a></h4>
<p>When the local node receives the <code>DISCOVER_NEIGHBORS</code> message replied by the remote node, it will send the <code>DISCOVER_PING</code> message to the received neighbor node in turn, and then if it receives the reply message <code>DISCOVER_PONG</code>, it will judge whether the corresponding K-bucket is full, if the K-bucket is not full, it will add the new node to the K bucket, if the K bucket is full, it will challenge one of the nodes, if the challenge is successful (send a <code>DISCOVER_PING</code> message to the old node, if it fails to receive the reply message <code>DISCOVER_PONG</code>, the challenge is successful, otherwise the challenge fails), the old node will be deleted from the K bucket, and the new node will be added to the K bucket.</p>
<p><img alt="image" src="https://raw.githubusercontent.com/tronprotocol/documentation-en/master/images/network_updatek.png" /></p>
<p>Nodes periodically perform node discovery tasks, continuously update K-buckets, and build their own node routing tables. The next step is to establish a connection with nodes.</p>
<h2 id="node-connection">Node Connection<a class="headerlink" href="#node-connection" title="Permanent link">&para;</a></h2>
<p>Before understanding how to establish a TCP connection between nodes, we need to first understand the peer node type.</p>
<h3 id="peer-node-management">Peer Node Management<a class="headerlink" href="#peer-node-management" title="Permanent link">&para;</a></h3>
<p>The local node needs to manage and classify peer nodes for efficient and stable node connection. Remote nodes can be divided into the following categories:</p>
<ul>
<li>Active nodes: specified in the configuration file. After the system starts, it will actively establish connections with the nodes. If the connection fails to be established, it will retry in each scheduled TCP connection task.</li>
<li>Passive nodes: specified in the configuration file. The local node will passively accept connections from them.</li>
<li>Trust nodes: specified in the configuration file, both Active nodes and Passive nodes are trusted nodes. When receiving a connection request from a trusted node, some other condition checks are skipped and the request is accepted directly.</li>
<li>BadNodes: When an abnormal protocol packet is received, the sending node will be added to the badNodes list, valid for 1 hour. When a connection request from badNodes is received, the request will be rejected directly</li>
<li>RecentlyDisconnectedNodes: When a connection is disconnected, the peer node will be added to the recentlyDisconnectedNodes list, valid for 30s, when a connection request from recentlyDisconnectedNodes is received, the request will be rejected directly</li>
</ul>
<h3 id="establish-tcp-connection-with-peers">Establish TCP Connection with Peers<a class="headerlink" href="#establish-tcp-connection-with-peers" title="Permanent link">&para;</a></h3>
<p>After the node is started, a scheduled task <code>poolLoopExecutor</code> will be created to establish a TCP connection with nodes. It will select nodes and establish connections with them. The working process is as follows:</p>
<p><img alt="image" src="https://raw.githubusercontent.com/tronprotocol/documentation-en/master/images/network_connect.png" /></p>
<p>The TCP connection can be mainly divided into two steps: first, determine the node list which the node will establish a connection with. The list needs to contain the active nodes that have not successfully established a connection, and then calculate the number of connections that also need to be established, and filter out the nodes from discovered neighbors according to the <a href="#node-filtering-strategy">node filtering strategy</a>, then score and sort them according to the <a href="#node-scoring-strategy">node scoring strategy</a>, and the corresponding number of nodes with the highest score is added to the request list. Finally, TCP connections are established with the nodes in the request list.</p>
<h4 id="node-filtering-strategy">Node Filtering Strategy<a class="headerlink" href="#node-filtering-strategy" title="Permanent link">&para;</a></h4>
<p>When establishing a node connection, it is necessary to filter out the following types of nodes and determine whether the node's own connection number has reached the maximum value.</p>
<ul>
<li>Myself</li>
<li>Nodes in the recentlyDisconnectedNodes list</li>
<li>Nodes in badNodes list</li>
<li>Nodes that have already established a connection</li>
<li>The number of connections established with the node IP has already reached the upper limit (maxConnectionsWithSameIp)</li>
</ul>
<p>But for trusted nodes, some filtering policies are ignored and connections are always established.</p>
<p><img alt="image" src="https://raw.githubusercontent.com/tronprotocol/documentation-en/master/images/network_filterrule.png" /></p>
<h4 id="node-scoring-strategy">Node Scoring Strategy<a class="headerlink" href="#node-scoring-strategy" title="Permanent link">&para;</a></h4>
<p>The node score is used to determine the priority of nodes to establish a connection. The higher the score, the higher the priority. Scoring dimensions include:</p>
<ul>
<li>Packet loss rate: The lower the packet loss rate, the better the communication quality. The score is inversely proportional to the packet loss rate. The highest score is 100 and the lowest is 0.</li>
<li>Network delay: The smaller the network delay, the better the network quality. The score is inversely proportional to the average network latency. The highest score is 20 and the lowest is 0.</li>
<li>TCP traffic: The larger the TCP traffic, the more active the communication. The score is proportional to the TCP traffic, with a maximum score of 20 and a minimum of 0</li>
<li>Disconnection times: The fewer disconnection times, the more stable the node is. The score is inversely proportional to the number of disconnections. The score is 10 times the number of disconnections.</li>
<li>Handshake: Nodes that have been handshake successfully before indicate that they have the same blockchain information, so it is preferred to establish a connection with them. When the number of successful Handshakes is greater than 0, the Handshake score is 20, otherwise, the score is 0.</li>
<li>Penalty state: A node in the Penalty state has a score of 0 and does not participate in scoring in other dimensions. The following situations will be regarded as in the Penalty state:<ul>
<li>Node disconnection time is less than 60s</li>
<li>The node is in the badNodes list</li>
<li>Inconsistent blockchain information</li>
</ul>
</li>
</ul>
<p>When calculating the node score, first determine whether the node is in the Penalty state, if so, the score is counted as 0, otherwise, the node score is the sum of the scores of each dimension.</p>
<h3 id="handshake">Handshake<a class="headerlink" href="#handshake" title="Permanent link">&para;</a></h3>
<p>After the TCP connection is successfully established, the node that actively initiates the TCP connection request will send a handshake message <code>P2P_HELLO</code> to the neighbor node, in order to confirm whether the blockchain information between the nodes is consistent and whether it is necessary to initiate the block synchronization process.</p>
<p>When the neighbor node receives <code>P2P_HELLO</code>, it will compare with the local information, such as checking whether the p2p version and the genesis block information are consistent. If all the check conditions are passed, it will reply to the <code>P2P_HELLO</code> message, and then perform the block synchronization or broadcast; otherwise, it will disconnect the connection.</p>
<h3 id="channel-keep-alive">Channel Keep-Alive<a class="headerlink" href="#channel-keep-alive" title="Permanent link">&para;</a></h3>
<p>Channel keep-alive is accomplished through <code>P2P_PING</code>, <code>P2P_PONG</code> TCP messages. When a node establishes a TCP connection with a neighbor node and handshakes successfully, the node will open a thread <code>pingTask</code> for the connection and periodically send <code>P2P_PING</code> messages to maintain the TCP connection, which is scheduled every 10s. If the <code>P2P_PONG</code> message replied is not received within the timeout period, the connection will be terminated.</p>
<h2 id="block-synchronization">Block Synchronization<a class="headerlink" href="#block-synchronization" title="Permanent link">&para;</a></h2>
<p>After completing the handshake with the peer node, if the peer node's blockchain is longer than the local blockchain, the block synchronization process <code>syncService.startSync</code> will be triggered according to the longest chain principle. The message interaction during the synchronization process is as follows:</p>
<p><img alt="image" src="https://raw.githubusercontent.com/tronprotocol/documentation-en/master/images/network_syncflow.png" /></p>
<p>Node A sends an <code>SYNC_BLOCK_CHAIN</code> message to peer node B to announce the blockchain summary information of the local chain. After the peer node B receives it, it calculates the list of missing blocks of node A, and sends the lost block ID list to node A through the <code>BLOCK_CHAIN_INVENTORY</code> message, carrying a maximum of 2000 block ids at a time.</p>
<p>After node A receives the <code>BLOCK_CHAIN_INVENTORY</code> message, it gets the missing block id, and sends a <code>FETCH_INV_DATA</code> message to node B asynchronously to request the missing block, up to 100 blocks at a time. If there are still blocks that need to be synchronized (that is, the remain_num in the <code>BLOCK_CHAIN_INVENTORY</code> message is greater than 0), a new round of block synchronization process will be triggered.</p>
<p>After node B receives the <code>FETCH_INV_DATA</code> message from node A, it sends the block to node A through the <code>BLOCK</code> message. After node A receives the <code>BLOCK</code> message, it asynchronously processes the block.</p>
<h3 id="blockchain-summary-and-list-of-missing-blocks">Blockchain Summary and List of Missing Blocks<a class="headerlink" href="#blockchain-summary-and-list-of-missing-blocks" title="Permanent link">&para;</a></h3>
<p>Below will take several different block synchronization scenarios as examples to illustrate the generation of the blockchain summary and the lost block ID list. </p>
<ul>
<li>Blockchain summary: an ordered list of block IDs, including the highest solidified block, the highest non-solidified block, and the blocks corresponding to the dichotomy.</li>
<li>List of missing blocks: The neighbor node compares its own chain with the received blockchain summary, determines the missing blocks list of peers, and returns a set of consecutive block IDs and the number of remaining blocks.</li>
</ul>
<h4 id="normal-synchronization-scene">Normal Synchronization Scene<a class="headerlink" href="#normal-synchronization-scene" title="Permanent link">&para;</a></h4>
<p>The height of the local header block is 1018, and the height of the solidified block is 1000. The two nodes have just established a connection, so the height of the common block is 0. The local blockchain summary of node A obtained by the dichotomy is 1000, 1010, 1015, 1017, and 1018.</p>
<p>After node B receives the blockchain summary of node A, combined with the local chain, it can produce the list of blocks that node A lacks: 1018, 1019, 1020, and 1021. Then, node A requests to synchronize blocks 1019, 1020, and 1021 according to the list of missing blocks.</p>
<p><img alt="image" src="https://raw.githubusercontent.com/tronprotocol/documentation-en/master/images/network_sync1.png" /></p>
<h4 id="chain-switching-scene">Chain-Switching Scene<a class="headerlink" href="#chain-switching-scene" title="Permanent link">&para;</a></h4>
<p>The head block height of the local main chain is 1018, and the height of the solidified block is 1000. The two nodes have just established a connection, so the height of the common block is 0. The local blockchain summary of node A obtained by the dichotomy is 1000, 1010, 1015, 1017, and 1018.</p>
<p>After node B receives the chain summary of node A, it finds that the local main chain is not the same as the main chain of node A, compares the chain summary of node A and finds that the common block height is 1015, then it computes the list of blocks that node A lacks are 1015, 1016', 1017', 1018', and 1019'. Then, node A requests to synchronize blocks 1018' and 1019' according to the list of missing blocks.</p>
<p><img alt="image" src="https://raw.githubusercontent.com/tronprotocol/documentation-en/master/images/network_sync2.png" /></p>
<p>In another switching chain scenario, the height of the local main chain header block is 1018, the height of the solidified block is 1000, and the common block is 1017', which is located on the fork chain. The local blockchain summary of node A obtained by the dichotomy is 1000, 1009, 1014, 1016', and 1017'.</p>
<p>After node B receives the chain summary of node A, combined with the local chain, it can produce the list of blocks that node A lacks 1017', 1018', and 1019'. Then, node A requests to synchronize blocks 1018', and 1019' according to the list of missing blocks.</p>
<p><img alt="image" src="https://raw.githubusercontent.com/tronprotocol/documentation-en/master/images/network_sync3.png" /></p>
<h2 id="block-and-transaction-broadcast">Block and Transaction Broadcast<a class="headerlink" href="#block-and-transaction-broadcast" title="Permanent link">&para;</a></h2>
<p>When the super representative node produces a new block, or the fullnode receives a new transaction initiated by the user, the transaction &amp; block broadcasting process will be initiated. When a node receives a new block or new transaction, it will forward the corresponding block or transaction, and the forwarding process is the same as that of broadcasting. The message interaction is shown in the following figure:</p>
<p><img alt="image" src="https://raw.githubusercontent.com/tronprotocol/documentation-en/master/images/network_broadcastflow.png" /></p>
<p>The types of messages involved include:</p>
<ul>
<li><code>INVENTORY</code> - broadcast list: list of block or transaction ids</li>
<li><code>FETCH_INV_DATA</code> - the list data that the node needs to get: block or transaction id list</li>
<li><code>BLOCK</code> - block data</li>
<li><code>TRXS</code> - transaction data</li>
</ul>
<p>Node A sends the transaction or block to be broadcast to Node B via the <code>INVENTORY</code> list message. After node B receives the <code>INVENTORY</code> list message, it needs to check the status of the peer node, and if it can receive the message, it puts the blocks/transactions in the list into the "to be fetched queue" <code>invToFetch</code>. If it is a block list, it will also trigger the "get block &amp; transaction task" immediately to send a <code>FETCH_INV_DATA</code> message to node A to get the block &amp; transaction.</p>
<p>After node A receives the <code>FETCH_INV_DATA</code> message, it will check whether an "INVENTORY" message has been sent to the peer. If it has been sent, it will send a transaction or block message to node B according to the list data. After node B receives the transaction or block message, it processes the message and triggers the forwarding process.</p>
<h2 id="summary">Summary<a class="headerlink" href="#summary" title="Permanent link">&para;</a></h2>
<p>This article introduces the implementation details related to the P2P network, the lowest level module of TRON, including node discovery, node connection, block synchronization, and the process of block and transaction broadcasting. I hope that reading this article can help developers to further understand and develop java-tron network-related modules.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../chainbase/" class="btn btn-neutral float-left" title="Chainbase"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../../contracts/compiler/" class="btn btn-neutral float-right" title="Dapp Development Tool">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/tronprotocol/documentation-en" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../chainbase/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../../contracts/compiler/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
